<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <!--
<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
<script type="text/javascript" src="../css/issStyle.js"></script>
-->
<style type="text/css">
<!--
body
{
    margin-left:  30px;
    margin-right: 30px;
};

P
{
    font-family: Tahoma;
    font-size: 10pt;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

a:hover {
    background-color: #cccccc;
}


hr {
    clear: both;
    height: 1px;
    color: #242424;
    background-color: transparent;
}

h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin: 10;
    margin-right: 15px;
    margin-bottom: 0.5em;
    padding-top: 0.5em;
    border-bottom: 1px solid #242424;
}

h1 {
    font-size: 150%;
    background-color: #b2c0ff;
}

h2 {
    background-color: #d9fbff;
    font-size: 110%;
}

h3 {
	background-color: #e6ccff;
    font-size: 80%;
}
h4 {
    background-color: #99ffcc;
    font-size: 100%;
	width: 750px;
}
#i {
    color: #ff1010;
}
tt{
	font-family: "Arial";
    font-size: 80%;
	color: #006600;
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #ccffff;
    color: #0033cc;
}
bc{
	font-family: "Arial";
	font-size: 80%;
	font-weight: bold;
    color: #990000;
	background-color: #fcf8c7;
}
k{
	font-family: "Arial";
	font-weight: bold;
    color: #990000;
	 
}
ks{
	font-family: "Arial";
	font-weight: bold;
    color: #0000CD	;
	 
}
kc{
	font-family: "Arial";
	font-weight: bold;
    color: #008000	;
	 
}
pre{
	font-family: "Helvetica";
	font-size: 100%;
	background-color: #fcf8c7;
	border: 1px solid blue;
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
	width: 800px;
    font-size: 18px;
}    
div.req{
	background-color: #d9ffb3;
    font-size: 18px;
	width: 700px;
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}       
div.remark{
	background-color: #FFFC33;     
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}  
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}         
    
  -->
</style>
    
<head>
   
<title>Lab3_2020</title></head>
    
<body>
<div id="top">
<h1>LabRobotUsage | Using the basicrobot  <font size="5"></font> </h1>
</div>  

<h2>Requirements</h2>
<div class="req">
Build a robot-radar system <em>robotAppl0</em> that includes a <em>basicrobot</em> (equipped with a <em>robot-sonar</em>), a <em>userconsole</em> 
and a <em>radarGui</em> so that:
<ol>
<h3>SPRINT1</h3>
<li><m><kc>REQ-SHOW-DATA</kc></m>: the data produced by the <em>robot-sonar</em> should be <i>properly</i> shown by the <em>radarGui</em>.</li>
<li><m><kc>REQ-MOVE</kc></m>: an human user can move the robot by using the  <em>userconsole</em>.</li>
<h3>SPRINT2</h3>
<li><m><kc>REQ-TURN</kc></m>:  the <em>basicrobot</em> must be able to detect obstacles and turn left of <m><k>90</k></m> degrees when an obstacle
is detected.</li>
<h3>SPRINT3</h3>
<li><m><kc>REQ-STEP</kc></m>:  the <em>basicrobot</em> must be able to execute a command <m><k>step(T)</k></m> that moves the robot for
the given time <m><k>T</k></m>.
</ol>
</div>

<h1>SPRINT1</h1>
<h2>Requirements</h2> 
<div class="req">
<ol>
<li><m><kc>REQ-SHOW-DATA</kc></m>: the data produced by the <em>robot-sonar</em> should be <i>properly</i> shown by the <em>radarGui</em>.</li>
<li><m><kc>REQ-MOVE</kc></m>: an human user can move the robot by using the  <em>userconsole</em>.</li>
 </ol>
</div>
<h2>Requirement analysis</h2> 
No requirement is given for the robot-radar interaction and for the console-robot interaction. Thus we can formalize the requirements as follows:
<br/><br/>
 <table style="width:98%">
<tbody>	

<tr>
<td style="width:55%" >
<pre><m>System <k>sprint1req</k>
Context ctxBasicRobot ip [ host= "192.168.43.171" port= 8018 ]  
Context ctxRobotAppl0 ip [ host= "localhost"      port= 8033 ]
Context ctxRadarGui   ip [ host= "192.168.43.5"   port= 8038 ]  

ExternalQActor <ks>basicrobot</ks> context ctxBasicRobot
ExternalQActor <ks>radargui</ks> context ctxRadarGui

QActor <ks>robotappl0</ks> context ctxRobotAppl0{
	State s0 initial{
		println("robotappl0 START")
		<kc>//REQ-MOVE: an human user can move the robot by using the userconsole.
		//REQ-SHOW-DATA: the robot-sonar data should be properly shown by the radarGui.</kc>
	}
}
</m></pre> 
<td>
<m>The system is composed of three components. <br/><br/>
The <em>basicrobot</em> and the <em>radarGui</em> are external with respect to the application system.<br/><br/>
The <em>userconsole</em> is supposed to be an 'alien' component, i.e. a component built without the qak metamodel<br/><br/>

No specification is given as regars interaction. This part has to be covered by problem analysis.
</m>
 </td>
</tr>
</tbody>
</table>

<h2>Problem analysis</h2> 


 <table style="width:98%">
<tbody>	

<tr>
<td style="width:50%" >
<pre><m>System <k>sprint1analysis</k>

Dispatch cmd	: cmd(X)			<kc>//sent by external interface</kc>
Event  polar	: polar( D,Angle)	<kc>//generated by sonarforradar</kc>

Context ctxBasicRobot ip [ host= "192.168.43.171" port= 8018 ]  
Context ctxRobotAppl0 ip [ host= "localhost"      port= 8033 ]
Context ctxRadarGui   ip [ host= "192.168.43.5"   port= 8038 ]  

ExternalQActor <ks>basicrobot</ks> context ctxBasicRobot
ExternalQActor <ks>radargui</ks> context ctxRadarGui

QActor <ks>robotappl0</ks> context ctxRobotAppl0{
	State s0 initial{ println("robotappl0 START") }
 	Goto work
 	
 	State work{}
	Transition t0 
		<k>whenMsg cmd</k> -> handleUserCmd
		<k>whenEvent polar</k> -> show
}
</m></pre> 
<ol>
<li>the <em>robotappl0</em> receives from the <em>userconsole</em> a dispatch <m><k>cmd</k></m> </li>
<li>the <em>robotappl0</em> handles <m><k>polar</k></m> events emitted by the <em>basicrobot</em> and 
forwards a <m><k>polar</k></m> dispatch to the <em>radarGui</em></li>
</ol>

<td>
for the following reasons:
<m><div class="remark">to be written by the reader ...</div></m>
 
<pre>
<m><kc>//REQ-MOVE </kc>
State handleUserCmd{
	onMsg( cmd : cmd(CMD) ) {
	<k>forward</k> <ks>basicrobot</ks> -m cmd : cmd( $payloadArg(0))
	}
}Goto work

<kc>//REQ-SHOW-DATA </kc>
State show{
	onMsg( polar : polar(D,A) ) {
	<k>forward</k> <ks>radargui</ks> -m polar : polar( $payloadArg(0), $payloadArg(1))
	}
}Goto work</m>
</pre>
We note that our new component  <em>robotappl0</em> simply re-directs information received from the 
<em>userconsole</em> and from the <em>basicrobot</em>. Now the question could be:
<m><div class="remark">is it possible to build a system composed by the <em>radarGui</em> and the <em>basicrobot</em> 
without introducing such a re-direction? </div></m>
</m>
 </td>
</tr>
</tbody>
</table>

<h2>Avoiding redirection</h2>
If we add to the default P2P qak-infrastructure the MQTT-based interaction support, any event can be directly perceived
by any QActor of the system. Therefore a <em>robotAppl0</em> system can be set-up by simply declaring the  <em>basicrobot</em>
and the <em>radarGui</em> with the specification of the MQTT support:

<pre>
<k>mqttBroker</k> "192.168.43.229" : 1883 

Context <ks>ctxBasicRobot</ks>	ip [ host= "localhost" port= 8018 ] <k>+mqtt</k> 
Context <ks>ctxRadarGui</ks>	ip [ host= "localhost" port= 8038 ] <k>+mqtt</k> 
</pre>

Now a console can be built as an 'alien' component that connects to the <m><k>mqttBroker</k></m> and then publish message 
in the qak standard representation on the topic <tt>unibo/qak/events</tt>. For example:

<h3 id="consolepython">A prototype of a console </h3>
Let us introduce a prototype of a console in Python:

<br/><br/>
 <table style="width:98%">
<tbody>	

<tr>
<td style="width:50%" ><m>
<pre>
<m>import time
import paho.mqtt.client as paho
brokerAddr	= "localhost"
topic		= <ks>"unibo/qak/events"</ks>   <k>#WARNING:</k> <kc>infrastructural detail!!!</kc>
eventTemplate	= <ks>"msg(userCmd,event,python,none,userCmd(<kc>CMDVAL</kc>),1)"</ks> <kc>#qak msg-rep</kc>

def <ks>emit</ks>( cmd ) :
    message = eventTemplate.replace("<kc>CMDVAL</kc>", cmd)
    msg = message + "\n"
    client.publish(topic, msg)

def console() :  
    cmd =  str( input() )
    while( len(cmd)==1 and cmd != "q"  ) :
        <ks>emit</ks>( cmd )
        cmd =  str(input())
<kc>################################################# </kc>  
client= paho.Client("sender")      
client.connect(brokerAddr)             
console()</m>
</pre>

</m></td>
<td><m>
<h3>WARNING</h3>
The console code 'knows' the name of the topic used to emit/perceive qak events.
This detail is allowable here, since we are just introducing a console prototype during system development. However:
<div class="remark">
The final console should consist in a user-GUI that completely hides any detail related to the interaction with the application.
</div>

This code can be executed by using the <i>jupyter file</i>
<a href="Appl0ConsoleMqtt.ipynb" target="code">Appl0ConsoleMqtt.ipynb</a>
</m>
</td>
</tr>
</tbody>
</table>




<h3>Towards systems based on the Subsumption architecture</h3>
Now, the actor <ks>robotappl0</ks> of the <em>robotAppl0</em> application is introduced just to 'extend' the behavior of the <em>basicrobot</em>.
In other words, we could structure the behavior of the system
by following the principles of <a href="https://en.wikipedia.org/wiki/Subsumption_architecture" target="web">Subsumption architecture</a>.
<br/><br/>
Just to give a very simple example, let us extend the behavior of the  <em>basicrobot</em> with respect to the handling of <tt>obstacle</tt> 
events by rotating the robot on the left of <tt>90</tt> degrees:

 <table style="width:98%">
<tbody>	

<tr>
<td style="width:50%" >
<pre><m><k>mqttBroker</k> "localhost" : 1883 
Event <ks>userCmd</ks>	: userCmd(X)			<kc>//by user interface</kc>
Event <ks>obstacle</ks>	: obstacle( DISTANCE )	<kc>//by sonaractorfilter</kc>
Event <ks>polar</ks>		: polar( D,Angle)		<kc>//by sonarforradar</kc>
Context ctxRadarGui ip [ host= "localhost"  port= 8038 ] <k>+mqtt</k>
QActor <ks>robotappl0</ks> context ctxRobotAppl0{
	State s0 initial{ println("robotappl0 START") }
 	Goto work
</m></pre> 
<m>
<kc>//REQ-MOVE </kc>: fulfilled by the <em>basicrobot</em>  
 <br/>
<kc>//REQ-SHOW-DATA </kc>: fulfilled by the <em>bradargui</em>  

</m>
<td>
<m>
The events emitted by <em>basicrobot</em> can in be perceived by the
<em>robotappl0 </em>. 
<br/>
The rotation of 90 degrees of the robot direction can be obtained by handling the event <tt>obstacle</tt> 
</br>
<pre>
State work{}
Transition t0 
	<k>whenEvent</k> <ks>obstacle</ks> -> handleObstacle

State handleObstacle{
	<ks>emit userCmd:userCmd(a)</ks>
}
Goto work</m>
</pre>
 
</m>
 </td>
</tr>
</tbody>
</table>
<div  class="remark">
The introduction of a layer that subsumes and extends the behavior of a lower-layer must be carefully designed
after a careful analysis of the problem.
</div>
<div class="body"> 

<h1>SPRINT2</h1>
<h2>Requirements</h2> 
The requirements set for the SPRINT2 is an example of some new behavior that we must add to that of the basic robot. 


<div class="req"><m><kc>REQ-TURN</kc></m>: the<em>basicrobot</em> must be able to detect obstacles and turn left of <m><k>90</k></m> degrees when an obstacle
is detected. </m> 
</div>

The discussion at the end of the previous section already tells us how to solve this problem. The only problem that arises in this case is whether the robot
first stops (lower-level) and then rotate (high-level) or first rotates and then stops.

<h1>SPRINT3</h1>
<h2>Requirements</h2>
<div class="req"><m><kc>REQ-STEP</kc></m>:  the <em>basicrobot</em> must be able to execute a command <m><k>step(T)</k></m> that moves the robot for
the given time <m><k>T</k></m>. <br/>
<m><kc>REQ-STEPABORT</kc></m>: if an <em>obstacle</em> is detected while performing a <m><k>step(T)</k></m>, the robot must return to its initial position.
The same must happen also when the user sends to the robot a command to <ks>stop</ks>.
</div>
 
<h2>Problem analysis</h2>
Now, the application layer does introduce its own way to move the the robot. As a consequence, the possibility to move the <em>basicrobot</em>
by emitting <em>usercmd</em> events should be excluded. To achieve this goal:
<ol>
<li>the application layer could be able to <i>inhibit</i> the behavior of the <em>basicrobot</em> (as suggested by the subsumption model)
or to <i>intercept</i> <em>usercmd</em> events;</li>
<li>the application layer could provide an <i>user-console</i> able to impose proper constraints to the interaction.</li>
</ol>

In the following, we will adopt the second strategy, by supposing that the console provided by the application
interacts with <em>robotappl0</em>  in a direct way, using a <tt>Dispatch</tt> <m><ks>cmd : cmd(MOVE)</ks></m>.

<br/><br/>
 <table style="width:98%">
<tbody>	

<tr>
<td style="width:50%" ><m>
<pre><m><k>mqttBroker</k> "localhost" : 1883 
Dispatch <ks>cmd</ks>   : cmd(X)	<kc>//sent by the user interface</kc>
Dispatch <ks>step</ks>  : step(T)	<kc>//sent by the user interface</kc>
Dispatch <ks>stop</ks>  : stop(V)	<kc>//sent by the user interface</kc>

Event <ks>userCmd</ks>	: userCmd(X)			<kc>//to move the basicrobot</kc>
Event <ks>obstacle</ks>	: obstacle( DISTANCE )	<kc>//from the basicrobot</kc>
Event <ks>polar</ks>	: polar( D,Angle)		<kc>//by sonarforradar</kc>
Event <ks>step</ks>     : step(T)			<kc>//emitted by user interface</kc>

Context ctxRadarGui ip [ host= "localhost"  port= 8038 ] <k>+mqtt</k>

QActor <ks>robotappl0</ks> context ctxRobotAppl0{
["
var <ks>StepTime=0L</ks>
var <ks>StepDuration=0L</ks>
"]
...
 State work{}
 Transition t0 
	whenEvent obstacle -> handleObstacle
	whenEvent step     -> doStep
	 
 <kc>//REQ-MOVE</kc>: fulfilled by the basicrobot  
 <kc>//REQ-SHOW-DATA</kc>: fulfilled by the basicrobot   	
 <kc>//REQ-TURN</kc>
 State handleObstacle{ emit userCmd:userCmd(a)} Goto work
 <kc>//REQ-STEP</kc>
 State doStep{
	onMsg( step : step(T ) ){
	["	StepDuration = 0L
		StepTime = payloadArg(0).toLong()
		startTimer()
	"]
		emit userCmd:userCmd(w)	<kc>#move the basicrobot</kc>
	}		 
 }
 Transition t0
	<k>whenTimeVar</k> <ks>StepTime</ks> -> endStep
	whenEvent <ks>obstacle</ks>   -> handleObstacleInStep
</m></pre> 
</m>
<td>
<m>
The <ks>robotappl0</ks> moves the <em>basicrobot</em> by emitting <ks>userCmd</ks> events
(hidden to the final user).
<br/><br/>
<kc>REQ-STEP</kc>: fulfilled when the given <ks>StepDuration</ks> expires:</m>
<pre><m><h3>Step done with success</h3>		
 State endStep{ 
	emit userCmd:userCmd(h) <kc>#stop the basicrobot</kc>
 } Goto work 
</m>
</pre>
<m><kc>REQ-STEPABORT</kc></m>: the robot returns to its initial position.</m>
<pre><m><h3>Step aborted for an obstacle</h3>	
 State handleObstacleInStep{
	["<ks>StepDuration</ks> = getDuration().toLong()"]	 
	emit userCmd:userCmd(s)  <kc>#back step</kc>
 }
 Transition t0 
	<k>whenTimeVar</k> StepDuration -> endStep
</m>
</pre>
 </td>
 
 
 
</tr>

</tbody>
</table>
<h3 id="console1">A new console prototype</h3>
The previous <a href="consolepython">prototype of console</a> must be now modified:
<br/><br/>
 <table style="width:98%">
<tbody>	

<tr>
<td style="width:50%" ><m>
<pre><m>brokerAddr     = "localhost"
robotName      = "robotappl0"
appl0topic     = <ks>"unibo/qak/"+robotName</ks>     <k>#WARNING</k>: <kc>infrastructural detail</kc>
cmdTemplate    = "msg(cmd,dispatch, python,"+ robotName +",cmd(CMDVAL),1)"
stepMsg        = "msg(step,dispatch,python,"+ robotName +",step(300),1)"
stopMsg        = "msg(stop,dispatch,python,"+ robotName +",stop(user),1)"

def <ks>forward</ks>( cmd ) :
    message = cmdTemplate.replace("CMDVAL", cmd) + "\n"
    client.publish(appl0topic, message)
def <ks>doStep</ks>():
    msg = stepMsg + "\n"
    client.publish(appl0topic, msg)
def <ks>doStop</ks>():
    msg = stopMsg + "\n"
    client.publish(appl0topic, msg)
	
...
#################################################   
client= paho.Client("sender")      
client.connect(brokerAddr)      
console()
</m></pre>
</m></td>
<td><m>
<div class="remark">
The final console should consist in a user-GUI that completely hides any detail related to the interaction with the application.
</div>
This code can be executed by using the <i>jupyter file</i>
<a href="Appl0ConsoleMqtt.ipynb" target="code">Appl0ConsoleMqtt.ipynb</a> 
or
<a href="Appl0Console.ipynb" target="code">Appl0Console.ipynb</a> (that uses the TCP connection with <em>robotAppl0</em> )
</m>
</td>
</tr>
</tbody>
</table>



			   
</div>  

<div style="background-color:rgba(86, 56, 253, 0.9); width:100%;text-align:center;font-size:small;color:white">
By AN Unibo-DISI  
</div> 

</body>
</html>